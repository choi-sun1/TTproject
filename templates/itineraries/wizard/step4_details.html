{% extends 'base.html' %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-progress">
        <div class="progress-step complete">1. 기본정보</div>
        <div class="progress-step complete">2. 장소선택</div>
        <div class="progress-step complete">3. 일정배치</div>
        <div class="progress-step active">4. 상세설정</div>
    </div>

    <div class="details-container">
        <form id="detailsForm">
            <div class="form-section">
                <h3>예산 설정</h3>
                <div class="budget-inputs">
                    {% for category in ['교통', '숙박', '식비', '관광', '쇼핑', '기타'] %}
                    <div class="budget-item">
                        <label>{{ category }}</label>
                        <input type="number" name="budget_{{ category }}" placeholder="0">
                        <span>원</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-section">
                <h3>체크리스트</h3>
                <div class="checklist-container">
                    <div class="default-items">
                        <!-- 기본 체크리스트 아이템들 -->
                    </div>
                    <button type="button" id="addChecklistItem" class="btn btn-secondary">
                        + 항목 추가
                    </button>
                </div>
            </div>

            <div class="form-section">
                <h3>공개 설정</h3>
                <div class="visibility-toggle">
                    <label class="switch">
                        <input type="checkbox" name="is_public" checked>
                        <span class="slider"></span>
                    </label>
                    <span>공개</span>
                    <p class="help-text">공개로 설정하면 다른 사용자가 내 일정을 볼 수 있습니다.</p>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">일정 만들기</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('detailsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        budgets: {},
        checklist: Array.from(document.querySelectorAll('.checklist-item'))
            .map(item => item.querySelector('input').value),
        is_public: formData.get('is_public') === 'on'
    };
    
    // 예산 데이터 수집
    ['교통', '숙박', '식비', '관광', '쇼핑', '기타'].forEach(category => {
        const amount = formData.get(`budget_${category}`);
        if (amount) {
            data.budgets[category] = parseInt(amount);
        }
    });

    // 서버에 최종 데이터 전송
    fetch('{% url "itineraries:wizard" step=4 %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        }
    });
});
</script>
{% endblock %}
