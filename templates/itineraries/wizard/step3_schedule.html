{% extends 'base.html' %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-progress">
        <div class="progress-step complete">1. 기본정보</div>
        <div class="progress-step complete">2. 장소선택</div>
        <div class="progress-step active">3. 일정배치</div>
        <div class="progress-step">4. 상세설정</div>
    </div>

    <div class="schedule-container">
        <div class="days-navigation">
            <!-- 일차 탭은 동적으로 생성됩니다 -->
        </div>

        <div class="schedule-grid">
            <div class="unassigned-places">
                <h3>선택된 장소</h3>
                <div id="unassignedPlacesList" class="draggable-container">
                    <!-- 선택된 장소들이 여기에 표시됩니다 -->
                </div>
            </div>

            <div class="daily-schedule">
                <h3>일정 <span id="currentDay">1일차</span></h3>
                <div id="scheduleTimeline" class="timeline">
                    <!-- 시간대별 일정이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>

        <div class="schedule-actions">
            <button id="optimizeRoute" class="btn btn-secondary">일정 최적화</button>
            <button id="nextStep" class="btn btn-primary">다음 단계</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 세션에서 선택된 장소들을 가져옵니다
    const selectedPlaces = JSON.parse(sessionStorage.getItem('selectedPlaces') || '[]');
    const days = parseInt(sessionStorage.getItem('totalDays') || 1);
    
    // 날짜 탭 생성
    createDayTabs(days);
    
    // 선택된 장소 목록 표시
    displayUnassignedPlaces(selectedPlaces);
    
    // 드래그 앤 드롭 초기화
    initializeDragAndDrop();
});

function createDayTabs(days) {
    const navigation = document.querySelector('.days-navigation');
    for (let i = 1; i <= days; i++) {
        const tab = document.createElement('button');
        tab.className = i === 1 ? 'day-tab active' : 'day-tab';
        tab.textContent = `${i}일차`;
        tab.dataset.day = i;
        tab.onclick = () => switchDay(i);
        navigation.appendChild(tab);
    }
}

function displayUnassignedPlaces(places) {
    const container = document.getElementById('unassignedPlacesList');
    places.forEach(place => {
        const div = document.createElement('div');
        div.className = 'place-item';
        div.draggable = true;
        div.dataset.placeId = place.id;
        div.innerHTML = `
            <h4>${place.name}</h4>
            <p>${place.address}</p>
        `;
        container.appendChild(div);
    });
}

function initializeDragAndDrop() {
    // 미할당 장소 목록의 드래그 앤 드롭
    new Sortable(document.getElementById('unassignedPlacesList'), {
        group: 'places',
        animation: 150
    });

    // 일정 타임라인의 드래그 앤 드롭
    new Sortable(document.getElementById('scheduleTimeline'), {
        group: 'places',
        animation: 150,
        onAdd: function(evt) {
            // 장소가 추가될 때 시간 입력 UI 표시
            showTimeInputDialog(evt.item);
        }
    });
}

document.getElementById('nextStep').addEventListener('click', function() {
    // 현재 일정 데이터 수집
    const scheduleData = collectScheduleData();
    
    // 서버에 데이터 전송
    fetch('{% url "itineraries:wizard" step=3 %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ schedule: scheduleData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.next_step) {
            window.location.href = `{% url "itineraries:wizard" step=4 %}`;
        }
    });
});
</script>
{% endblock %}
