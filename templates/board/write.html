{% extends 'base.html' %}

{% block content %}
<div class="board-container">
    <div class="board-header">
        <h2>게시글 작성</h2>
    </div>
    <form method="post" class="post-form" enctype="multipart/form-data">
        {% csrf_token %}
        {% if form.errors %}
            <div class="error-message">
                {% for field in form %}
                    {% for error in field.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                {% endfor %}
            </div>
        {% endif %}
        <div class="form-group">
            <label for="title">제목</label>
            {{ form.title }}
        </div>
        
        <div class="editor-toolbar">
            <button type="button" onclick="insertMarkdown('**', '**')" title="굵게">B</button>
            <button type="button" onclick="insertMarkdown('*', '*')" title="기울임">I</button>
            <button type="button" onclick="insertMarkdown('# ', '')" title="제목 1">H1</button>
            <button type="button" onclick="insertMarkdown('## ', '')" title="제목 2">H2</button>
            <button type="button" onclick="insertMarkdown('### ', '')" title="제목 3">H3</button>
            <button type="button" onclick="insertMarkdown('- ', '')" title="목록">•</button>
            <button type="button" onclick="insertMarkdown('[', '](url)')" title="링크">Link</button>
            <select onchange="insertImageAlign(this.value)">
                <option value="">이미지 정렬</option>
                <option value="left">왼쪽</option>
                <option value="center">가운데</option>
                <option value="right">오른쪽</option>
            </select>
        </div>

        <div class="form-group">
            <label for="content">내용</label>
            {{ form.content }}
            <div class="markdown-help">
                <small class="text-muted">
                    마크다운 문법: **굵게**, *기울임*, # 제목, - 목록, [링크](URL)
                </small>
            </div>
        </div>

        <div class="form-group">
            <label for="images">이미지 첨부</label>
            <input type="file" id="images" name="images" class="form-control" 
                   accept="image/*" multiple onchange="handleImageUpload(this)">
            <small class="text-muted">최대 10개의 이미지 파일(각 5MB 이하)</small>
        </div>
        <div id="imagePreview" class="image-preview"></div>
        <div class="form-actions">
            <button type="button" class="btn-preview" onclick="togglePreview()">미리보기</button>
            <button type="submit" class="btn-primary">작성완료</button>
            <a href="{% url 'board:list' %}" class="btn-cancel">취소</a>
        </div>
    </form>
</div>

<!-- Marked.js 라이브러리 추가 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let isPreviewMode = false;

function insertMarkdown(prefix, suffix) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const before = text.substring(0, start);
    const selection = text.substring(start, end);
    const after = text.substring(end);
    
    textarea.value = before + prefix + selection + suffix + after;
    textarea.focus();
    textarea.selectionStart = start + prefix.length;
    textarea.selectionEnd = start + prefix.length + selection.length;
}

function insertImageAlign(align) {
    if (!align) return;
    const alignText = `<div style="text-align: ${align};">\n![이미지 설명](이미지 URL)\n</div>`;
    insertMarkdown(alignText, '');
}

function togglePreview() {
    const editor = document.getElementById('content');
    const preview = document.getElementById('preview');
    const previewBtn = document.querySelector('.btn-preview');
    
    isPreviewMode = !isPreviewMode;
    if (isPreviewMode) {
        preview.innerHTML = marked.parse(editor.value);
        preview.style.display = 'block';
        editor.style.display = 'none';
        previewBtn.textContent = '에디터';
    } else {
        preview.style.display = 'none';
        editor.style.display = 'block';
        previewBtn.textContent = '미리보기';
    }
}

function previewImages(input) {
    const preview = document.getElementById('imagePreview');
    const fileCountDiv = document.getElementById('selectedFileCount');
    preview.innerHTML = '';
    
    if (input.files.length > 10) {
        alert('이미지는 최대 10개까지만 선택할 수 있습니다.');
        input.value = '';
        fileCountDiv.textContent = '';
        return;
    }

    // 선택된 파일 개수 표시
    fileCountDiv.textContent = `선택된 이미지: ${input.files.length}개`;

    // 각 파일 크기와 타입 검사
    for (let file of input.files) {
        if (file.size > 5 * 1024 * 1024) {
            alert(`${file.name}의 크기가 5MB를 초과합니다.`);
            input.value = '';
            preview.innerHTML = '';
            fileCountDiv.textContent = '';
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            alert(`${file.name}은(는) 이미지 파일이 아닙니다.`);
            input.value = '';
            preview.innerHTML = '';
            fileCountDiv.textContent = '';
            return;
        }

        // 이미지 미리보기 생성
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="미리보기">
                <span class="file-name">${file.name}</span>
            `;
            preview.appendChild(div);
        }
        reader.readAsDataURL(file);
    }
}

function handleImageUpload(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (input.files.length > 10) {
        alert('이미지는 최대 10개까지만 선택할 수 있습니다.');
        input.value = '';
        return;
    }

    for (let file of input.files) {
        if (file.size > 5 * 1024 * 1024) {
            alert('각 이미지의 크기는 5MB를 초과할 수 없습니다.');
            input.value = '';
            preview.innerHTML = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            preview.appendChild(div);
        }
        reader.readAsDataURL(file);
    }
}
</script>

<style>
.mt-2 { margin-top: 0.5rem; }
.file-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    font-size: 0.8rem;
    padding: 0.25rem;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.editor-toolbar {
    padding: 0.5rem;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    display: flex;
    gap: 0.5rem;
}

.editor-toolbar button {
    padding: 0.25rem 0.5rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.editor-toolbar button:hover {
    background: #f1f3f5;
}

.editor-toolbar select {
    padding: 0.25rem 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.editor-container {
    position: relative;
}

.markdown-preview {
    display: none;
    min-height: 300px;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
}

.markdown-preview img {
    max-width: 100%;
    height: auto;
}

.btn-preview {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
}

.btn-preview:hover {
    background: #5a6268;
}

/* 이미지 정렬 스타일 */
.img-left { float: left; margin-right: 1rem; }
.img-center { display: block; margin: 0 auto; }
.img-right { float: right; margin-left: 1rem; }
</style>
{% endblock %}
