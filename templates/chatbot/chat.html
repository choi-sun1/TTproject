{% extends 'base.html' %}
{% load static %}
{% block title %}AI 여행 플래너 - SmartTrip{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
{% endblock %}
{% block content %}
<div class="chatbot-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button id="new-chat" class="new-chat-btn">
                <i class="fas fa-plus"></i>
                새로운 대화
            </button>
            <button id="show-history" class="show-history-btn">
                <i class="fas fa-history"></i>
                이전 대화
            </button>
        </div>
    </div>
    <div class="chat-main">
        <div class="chat-header">
            <h2><i class="fas fa-robot"></i> AI 여행 플래너</h2>
            <p>맞춤형 여행 계획을 도와드립니다</p>
        </div>
        <!-- 📌 채팅 메시지 창 (스크롤 가능) -->
        <div class="chat-messages" id="chat-messages">
            {% if show_history %}
                {% for conversation in conversations %}
                    <div class="message user">
                        <div class="message-content">
                            {{ conversation.user_message }}
                        </div>
                    </div>
                    <div class="message bot">
                        <div class="message-content">
                            {{ conversation.bot_reply }}
                        </div>
                    </div>
                {% empty %}
                    <p class="empty-message">이전 대화가 없습니다.</p>
                {% endfor %}
            {% else %}
                {% if new_message %}
                    <div class="message user">
                        <div class="message-content">
                            {{ new_message.user_message }}
                        </div>
                    </div>
                    <div class="message bot">
                        <div class="message-content">
                            {{ new_message.bot_reply }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
        <!-- 📌 입력창 (하단 고정) -->
        <div class="chat-input">
            <form id="chat-form" method="POST">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" 
                           id="user-input" 
                           name="user_message"
                           placeholder="여행 계획에 대해 물어보세요..." 
                           autocomplete="off"
                           required>
                    <button type="submit" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 📌 스크롤 유지 기능 추가 -->
<script>
    function scrollToBottom() {
        var chatBox = document.getElementById("chat-messages");
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    window.onload = function() {
        scrollToBottom();
    };
    // 폼 제출 시 새로운 메시지만 추가하고 스크롤 유지
    document.getElementById("chat-form").addEventListener("submit", function(event) {
        event.preventDefault();
        let userInput = document.getElementById("user-input");
        let userMessage = userInput.value.trim();
        if (userMessage === "") return;
        // 사용자 메시지 추가
        let chatBox = document.getElementById("chat-messages");
        let userDiv = document.createElement("div");
        userDiv.classList.add("message", "user");
        let userContent = document.createElement("div");
        userContent.classList.add("message-content");
        userContent.innerHTML = userMessage;
        userDiv.appendChild(userContent);
        chatBox.appendChild(userDiv);
        // 입력 초기화
        userInput.value = "";
        scrollToBottom();
        // 서버로 메시지 전송 (AJAX)
        fetch("{% url 'chatbot:chat' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "user_message=" + encodeURIComponent(userMessage)
        })
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");
            let newMessage = doc.querySelector(".message.bot .message-content");
            if (newMessage) {
                let botDiv = document.createElement("div");
                botDiv.classList.add("message", "bot");
                botDiv.appendChild(newMessage);
                chatBox.appendChild(botDiv);
                scrollToBottom();
            }
        })
        .catch(error => console.error("Error:", error));
    });
    // 새로운 대화 버튼 클릭 시 새로운 대화 뷰 호출
    document.getElementById("new-chat").addEventListener("click", function() {
        window.location.href = "{% url 'chatbot:new_chat' %}";
    });
    // 이전 대화 버튼 클릭 시 대화 내역 표시
    document.getElementById("show-history").addEventListener("click", function() {
        window.location.href = "{% url 'chatbot:chat' %}?show_history=true";
    });
</script>
{% endblock %}