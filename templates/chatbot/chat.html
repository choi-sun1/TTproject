{% extends 'base.html' %}
{% load static %}
{% block title %}AI ì—¬í–‰ í”Œë˜ë„ˆ - SmartTrip{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
{% endblock %}
{% block content %}
<div class="chatbot-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button id="new-chat" class="new-chat-btn">
                <i class="fas fa-plus"></i>
                ìƒˆë¡œìš´ ëŒ€í™”
            </button>
            <button id="show-history" class="show-history-btn">
                <i class="fas fa-history"></i>
                ì´ì „ ëŒ€í™”
            </button>
        </div>
    </div>
    <div class="chat-main">
        <div class="chat-header">
            <h2><i class="fas fa-robot"></i> AI ì—¬í–‰ í”Œë˜ë„ˆ</h2>
            <p>ë§ì¶¤í˜• ì—¬í–‰ ê³„íšì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤</p>
        </div>
        <!-- ğŸ“Œ ì±„íŒ… ë©”ì‹œì§€ ì°½ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
        <div class="chat-messages" id="chat-messages">
            {% if show_history %}
                {% for conversation in conversations %}
                    <div class="message user">
                        <div class="message-content">
                            {{ conversation.user_message }}
                        </div>
                    </div>
                    <div class="message bot">
                        <div class="message-content">
                            {{ conversation.bot_reply }}
                        </div>
                    </div>
                {% empty %}
                    <p class="empty-message">ì´ì „ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            {% else %}
                {% if new_message %}
                    <div class="message user">
                        <div class="message-content">
                            {{ new_message.user_message }}
                        </div>
                    </div>
                    <div class="message bot">
                        <div class="message-content">
                            {{ new_message.bot_reply }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
        <!-- ğŸ“Œ ì…ë ¥ì°½ (í•˜ë‹¨ ê³ ì •) -->
        <div class="chat-input">
            <form id="chat-form" method="POST">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" 
                           id="user-input" 
                           name="user_message"
                           placeholder="ì—¬í–‰ ê³„íšì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”..." 
                           autocomplete="off"
                           required>
                    <button type="submit" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- ğŸ“Œ ìŠ¤í¬ë¡¤ ìœ ì§€ ê¸°ëŠ¥ ì¶”ê°€ -->
<script>
    function scrollToBottom() {
        var chatBox = document.getElementById("chat-messages");
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    window.onload = function() {
        scrollToBottom();
    };
    // í¼ ì œì¶œ ì‹œ ìƒˆë¡œìš´ ë©”ì‹œì§€ë§Œ ì¶”ê°€í•˜ê³  ìŠ¤í¬ë¡¤ ìœ ì§€
    document.getElementById("chat-form").addEventListener("submit", function(event) {
        event.preventDefault();
        let userInput = document.getElementById("user-input");
        let userMessage = userInput.value.trim();
        if (userMessage === "") return;
        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        let chatBox = document.getElementById("chat-messages");
        let userDiv = document.createElement("div");
        userDiv.classList.add("message", "user");
        let userContent = document.createElement("div");
        userContent.classList.add("message-content");
        userContent.innerHTML = userMessage;
        userDiv.appendChild(userContent);
        chatBox.appendChild(userDiv);
        // ì…ë ¥ ì´ˆê¸°í™”
        userInput.value = "";
        scrollToBottom();
        // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ (AJAX)
        fetch("{% url 'chatbot:chat' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "user_message=" + encodeURIComponent(userMessage)
        })
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");
            let newMessage = doc.querySelector(".message.bot .message-content");
            if (newMessage) {
                let botDiv = document.createElement("div");
                botDiv.classList.add("message", "bot");
                botDiv.appendChild(newMessage);
                chatBox.appendChild(botDiv);
                scrollToBottom();
            }
        })
        .catch(error => console.error("Error:", error));
    });
    // ìƒˆë¡œìš´ ëŒ€í™” ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆë¡œìš´ ëŒ€í™” ë·° í˜¸ì¶œ
    document.getElementById("new-chat").addEventListener("click", function() {
        window.location.href = "{% url 'chatbot:new_chat' %}";
    });
    // ì´ì „ ëŒ€í™” ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€í™” ë‚´ì—­ í‘œì‹œ
    document.getElementById("show-history").addEventListener("click", function() {
        window.location.href = "{% url 'chatbot:chat' %}?show_history=true";
    });
</script>
{% endblock %}